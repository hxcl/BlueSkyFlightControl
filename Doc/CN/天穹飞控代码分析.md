# 天穹飞控代码分析

## 任务流程

天穹飞控使用 FreeRTOS 进行管理，下面列出了所有的任务并对其执行频率、功能等进行了说明。

| 任务名称             | 任务优先级 | 执行频率/Hz | 任务说明                           | 补充                   |
| -------------------- | ---------- | ----------- | ---------------------------------- | ---------------------- |
| vImuSensorReadTask   | 13         | 1000        | 读取陀螺仪与加速度计的原始数据     | 通过队列发送结果       |
| vImuDataPreTreatTask | 12         | 1000        | 对陀螺仪和加速度计的原始数据预处理 | 通过队列接收和发送结果 |
| vNavigationTask      | 11         | 1000        | 卡尔曼滤波预测姿态                 |                        |
|                      |            |             | 飞行速度估计与位置估计             |                        |
| vFlightControlTask   | 10         | 100         | 遥控器控制与失控检测               |                        |
|                      |            | 200         | 位置外环                           |                        |
|                      |            | 50          | 用户控制                           |                        |
|                      |            | 50          | 任务控制                           |                        |
|                      |            | 50          | 位置内环                           |                        |
|                      |            | 50          | 姿态外环                           |                        |
|                      |            | 50          | 高度外环                           |                        |
|                      |            | 50          | 姿态与高度内环                     |                        |
|                      |            | 1000        | 电机更新                           |                        |
| vSensorUpdateTask    | 8          | 100         | 地磁传感器读取                     |                        |
|                      |            | 50          | 气压传感器读取                     |                        |
|                      |            | 20          | 飞控参数保存                       |                        |
|                      |            | 200         | 电池状态与 RGB 灯                  |                        |
| vOtherSensorTask     | 7          | 100         | 地磁数据预处理                     |                        |
|                      |            | 25          | 气压数据预处理                     |                        |
|                      |            | 10          | GPS 数据处理                       |                        |
| vMessageTask         | 6          | 100         | bsplink/mavlink 数据发送           |                        |
| vFlightStatusTask    | 5          | 100         | 飞行状态刷新等                     | 要详细了解作用         |
| vLogTask             | 3          | 100         | 向 TF 卡写入飞行日志               |                        |

## 各任务详细内容

### main()

`main()` 中没有太多的内容，常规的 `HAL_Init()` 和 `SystemClock_Config()` 完成以后即按照 FreeRTOS 的推荐创建起始任务，然后初始化 FreeRTOS 相关配置并开启调度，将控制权交予调度器，此时程序应该进入到起始任务中。

### vStartTask

起始任务包含初始化、任务创建和状态更新三部分。

`Board_Init()`其实就是 `MX_XXX_Init()`的汇总，某些外设可能还加入了额外的内容。在这一步，RGB 灯会全数熄灭。`ParamInit()`从 Flash 中读取参数并校验，如果校验失败，会将所有参数置零。需要注意的是，这里的置零是指保存在内存中的参数置零，而不是将零值写入 Flash 里面，后者的操作是异步的。`FaultDetectInit()` 将错误和警告标志位清零，然后置位“系统初始化”警告标志位。`MessageQueueCreate()`顾名思义，为任务间通信提供消息队列，至于具体的可以看上面部分或者代码。

任务创建部分比较简单，依次调用任务创建函数即可。

完成上述工作以后，空闲任务进入到循环中。起始任务的优先级为 0 与空闲任务相同，因此会隔 5s 更新一次 CPU 使用率和栈使用情况，与空闲任务交替进行。

### vImuSensorReadTask

如前文所述，该任务拥有最高优先级，运行频率 1kHz。它的主要任务是读取 IMU 的加速度、角速度原始数据和温度数据并填充到相应的消息队列当中，传递给下一个任务。该任务还同时承担了检测 IMU 状态的任务：在读取数据之前会首先挂起调度器检测 IMU 状态，若 IMU 未能正确相应，将置位相应的警告标识。

### vImuDataPreTreatTask



## 姿态估计

姿态估计位于 /SRC/NAVIGATION/ 目录下，分为姿态估计和辅助姿态估计两部分。

辅助姿态估计使用 Kalmann 滤波算法进行姿态估计，但不包括 Yaw 角的估计。在进行姿态估计之前，初始对准函数会采样加速度测量值并求平均，意味着**静止状态的加速度向量作为 Kalmann 滤波状态的初始状态**，加速度和磁力计测量值则共同计算得到当前欧拉角与四元数。初始计算完成以后不再进行初始对准。辅助姿态估计首先对向心加速度进行补偿，然后将六轴数据使用 Kalmann 滤波算法计算得到欧拉角。具体来说，首先加速度测量值减去向心加速度（在姿态估计中给出）的偏差，角速度测量值通过积分得到角速度变化量并转化为 DCM 作为 Kalmann 滤波的状态转移矩阵，经过 Kalmann 滤波算法得到**当前的状态值，以加速度向量的形式**。

辅助姿态估计的显著问题是它直接使用加速度值作为 Kalmann 滤波算法的观测量输入，忽略了运动加速度的影响。这一问题将在正式的姿态估计部分解决，也因为如此，辅助姿态估计的最后一个任务是根据姿态预测结果，给出飞行器的运动加速度。

姿态估计同样使用 Kalmann 滤波算法进行。在进行之前会有初始对准的过程，加速度测量值和磁力计测量值分别作为 Roll & Pitch 估计的初始状态和 Yaw 估计的初始状态。俯仰/偏航估计过程与辅助姿态估计相似，区别是加速度测量值会经过运动加速度补偿、向心加速度补偿和零偏补偿，其中**运动加速度的数据来自辅助姿态估计**。偏航估计过程较为简单，同样是角速度积分转化为 DCM 作为状态转移矩阵预估计，再用磁强观测量完成估计。

尽管姿态估计过程看起来并不复杂，但仍有许多值得探究的地方。例如初始化过程的处理、运动加速度的补偿参数等。

